<script>
(function() {
  var map = L.map("sightings-map").setView([45.5, -122.8], 8);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 16,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);
  var obs = {{ markers_json|safe }};

  function buildPopup(o) {
    var html = '<div class="obs-popup">';
    if (o.photo) {
      html += '<img class="obs-popup-img" src="' + o.photo + '" alt="' + o.name + '">';
    }
    html += '<div class="obs-popup-body">';
    html += '<span style="color:' + o.color + ';font-weight:700">&#9679;</span> ';
    html += '<b>' + o.name + '</b><br><i>' + o.species + '</i>';
    html += '<br>' + o.date;
    if (o.weather) {
      html += '<br><span class="obs-popup-weather">' + o.weather + '</span>';
    }
    html += '<br><a href="' + o.url + '" target="_blank">View on iNaturalist</a>';
    html += '</div></div>';
    return html;
  }

  // --- Sightings marker layer ---
  var markers = L.layerGroup();
  for (var i = 0; i < obs.length; i++) {
    var o = obs[i];
    var m = L.circleMarker([o.lat, o.lon], {
      radius: 11, fillColor: o.color, color: '#fff',
      weight: 1.5, opacity: 0.9, fillOpacity: 0.85
    });
    m.bindPopup(buildPopup(o), {maxWidth: 280, minWidth: 200});
    m.bindTooltip(o.initials, {permanent: true, direction: "center",
      className: "map-label", offset: [0, 0]});
    markers.addLayer(m);
  }

  // --- Density heat map layer ---
  var heatPoints = [];
  for (var j = 0; j < obs.length; j++) {
    heatPoints.push([obs[j].lat, obs[j].lon]);
  }
  var heat = L.heatLayer(heatPoints, {
    radius: 18,
    blur: 22,
    maxZoom: 12,
    max: 1.0,
    gradient: {0.2: '#ffffb2', 0.4: '#fecc5c', 0.6: '#fd8d3c', 0.8: '#f03b20', 1.0: '#bd0026'}
  });

  // --- Layer control ---
  var overlays = {
    "Sightings": markers,
    "Density": heat
  };
  L.control.layers(null, overlays, {collapsed: false, position: 'topright'}).addTo(map);

  // Both layers on by default; heat underneath markers
  heat.addTo(map);
  markers.addTo(map);

  L.rectangle([[44.5, -124.2], [46.5, -121.5]], {
    color: '#555', weight: 1.5, dashArray: '6 4',
    fill: false, opacity: 0.5
  }).addTo(map).bindPopup('Search area: NW Oregon / SW Washington');
  if (obs.length > 0) {
    var bounds = L.latLngBounds(obs.map(function(o) { return [o.lat, o.lon]; }));
    map.fitBounds(bounds, {padding: [30, 30]});
  }
})();
</script>
